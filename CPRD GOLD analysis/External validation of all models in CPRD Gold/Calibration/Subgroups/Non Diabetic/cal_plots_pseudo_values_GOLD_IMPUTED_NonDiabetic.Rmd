
---
title: "R Notebook"
output: html_notebook
---


```{r}

rm(list=ls())

if (!require("pacman")) install.packages("pacman")
library(pacman)

library(riskRegression)

pacman::p_load(
  survival,
  rms,
  cmprsk,
  mstate,
  pseudo,
  pec,
  plotrix,
  knitr,
  splines,
  kableExtra,
  gtsummary,
  boot,
  tidyverse,
  rsample,
  gridExtra,
  webshot
)

library(readstata13)

```

# Models

## 1. Benchmark model

```{r}
benchmark = readRDS("/rds/projects/s/subramaa-mum-predict/SteveW/KFRE/Final dataset/GOLD data September 2024/Benchmark models/Linked data/gold_imputed_data_ready_for_validation.rds")

benchmark = subset(benchmark,benchmark$diabetic==0)

```

### Calculating the risk scores using the Benchmark model

```{r}

s2_benchmark = 0.9878
s5_benchmark = 0.9570

x = benchmark %>% dplyr::mutate(

  sex=ifelse(female== 0, 1, 0),
  logACR = ACR_value,
  age = Age2,
  age1 = age/10,
  egfr1 = EGFR2/5,

  LP = ((-0.2201*(age1-7.036))
                  + (0.2467*(sex-0.5642))
                  - (0.5567*(egfr1-7.222))+
                    (0.4510*(logACR-5.137))),
   ### 2 years
  score_2yrs_benchmark = (1-(s2_benchmark ^ exp(LP))),
   ### 5 years
  score_5yrs_benchmark = (1-(s5_benchmark ^ exp(LP))),


  time2yrs = ifelse(time1>2,2,time1),
  time5yrs = ifelse(time1>5,5,time1),
  status2yrs = ifelse(time1>2,0,status1),
  status5yrs = ifelse(time1>5,0,status1),
  patient_id = PRACTICE_PATIENT_ID)

```

##### 2 years

```{r}

start_time = Sys.time()

# Calibration plot (pseudo-obs approach) ----------------------------------
# First compute riskRegression::Score()

vdata <- x %>% 
  dplyr::select(patient_id, score_2yrs_benchmark, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 2
pred <- as.matrix(vdata$pred)


score_vdata <- riskRegression::Score(
  list("KFRE_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  #  metrics = c("auc", "brier"),
  summary = c("ipa"),
  cause = primary_event,
  plots = "calibration"
)

# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)
pseudos <- pseudos[order(pseudos$risk), ]

library(parallel)
pseudos = list(pseudos)
smooth_pseudos = mclapply(pseudos, function(x){
  smooth_pseudos <- predict(stats::loess(pseudovalue ~ risk, data = x,  span=0.33, degree = 1), se = F)
},mc.cores = 50)
# Use linear loess (weighted local regression with polynomial span=0.25, degree = 1) smoothing
#smooth_pseudos <- predict(stats::loess(pseudovalue ~ risk, data = pseudos,span = 0.25, span=0.25, degree = 1), se = F)

smooth_pseudos1 = data.frame(smooth_pseudos[[1]])
names(smooth_pseudos1)=c("smooth_pseudos")
pseudos = pseudos[[1]]

pseudo_vals_overall <- data.frame(
  obs = smooth_pseudos1$smooth_pseudos, 
  risk = pseudos$risk,
  Category = "Overall")

Sys.time()-start_time

```


###### Plot

```{r}
pdf("PseudoCal_2yearBenchmark.pdf")

pseudo_vals_overall %>%
  ggplot(aes(x = risk, y = obs)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2) +
  geom_line() +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed outcome proportions") -> p1


print(p1)
dev.off()

two_year_cal_data = pseudo_vals_overall

```


###### Intercept and slope

```{r}

## Calibration intercept and slope --------------------------------------
# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)

# Note:
# - 'pseudos' is the data.frame with ACTUAL pseudo-observations, not the smoothed ones
# - Column ID is not the id in vdata; it is just a number assigned to each row of
# the original validation data sorted by time and event indicator
pseudos$cll_pred <- log(-log(1 - pseudos$risk)) # add the cloglog risk ests

# Fit model for calibration intercept
fit_cal_int <- geese(
  pseudovalue ~ offset(cll_pred),
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Fit model for calibration slope
fit_cal_slope <- geese(
  pseudovalue ~ offset(cll_pred) + cll_pred,
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Perform joint test on intercept and slope
betas <- fit_cal_slope$beta
vcov_mat <- fit_cal_slope$vbeta
wald <- drop(betas %*% solve(vcov_mat) %*% betas)
# pchisq(wald, df = 2, lower.tail = FALSE)
```




```{r}

k <- 3
res_cal <- rbind(

  # Value, confidence interval and test for calibration intercept
  "Intercept" = with(
    summary(fit_cal_int)$mean,
    c(
      "estimate" = estimate,
      `2.5 %` = estimate - qnorm(0.975) * san.se,
      `97.5 %` = estimate + qnorm(0.975) * san.se
    )
  ),

  # Value, confidence interval and test for calibration slope
  "Slope" = with(
    summary(fit_cal_slope)$mean["cll_pred", ],
    c(
      "estimate" = 1 + estimate,
      `2.5 %` = 1 + (estimate - qnorm(0.975) * san.se),
      `97.5 %` = 1 + (estimate + qnorm(0.975) * san.se)
    )
  )
)

res_cal_2years <- round(res_cal, k)

write.csv(res_cal_2years,"res_cal_2years.csv")
res_cal_2years


```

###### Observed/Expected ratio 

```{r}
## Observed/Expected ratio --------------------------------------------
# First calculate Aalen-Johansen estimate (as 'observed')

sf <- survfit(Surv(time, status, type = "mstate") ~ 1, data = vdata)
obj <- summary(sf, times = horizon)

# column 1 is event-free; column 2 is cause 1; column 3 is cause 2
primary_event <- 1
aj <- list(
  obs = obj$pstate[, primary_event + 1],
  se  = obj$std.err[, primary_event + 1]
)

# Calculate O/E
OE <- aj$obs / mean(pred)

# For the confidence interval we use method proposed in Debray et al. (2017) doi:10.1136/bmj.i6460
k <- 3
alpha <- 0.05
OE_summary <- base::cbind(
  "estimate" = OE,
  `2.5 %` = exp(log(OE) - qnorm(1 - alpha / 2) * aj$se / aj$obs),
  `97.5 %` = exp(log(OE) + qnorm(1 - alpha / 2) * aj$se / aj$obs))


OE_summary <- base::round(OE_summary, k)
rownames(OE_summary) <- "O/E ratio"

write.csv(OE_summary,"OE_summary_2yrs_benchmark.csv")

OE_summary_2years = OE_summary

```




##### 5 years

```{r}

start_time = Sys.time()

# Calibration plot (pseudo-obs approach) ----------------------------------
# First compute riskRegression::Score()

vdata <- x %>% 
  dplyr::select(patient_id, score_5yrs_benchmark, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 5
pred <- as.matrix(vdata$pred)


score_vdata <- riskRegression::Score(
  list("KFRE_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  #  metrics = c("auc", "brier"),
  summary = c("ipa"),
  cause = primary_event,
  plots = "calibration"
)

# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)
pseudos <- pseudos[order(pseudos$risk), ]


pseudos = list(pseudos)
smooth_pseudos = mclapply(pseudos, function(x){
  smooth_pseudos <- predict(stats::loess(pseudovalue ~ risk, data = x,  span=0.33, degree = 1), se = F)
},mc.cores = 50)
# Use linear loess (weighted local regression with polynomial span=0.25, degree = 1) smoothing
#smooth_pseudos <- predict(stats::loess(pseudovalue ~ risk, data = pseudos,span = 0.25, span=0.25, degree = 1), se = F)

smooth_pseudos1 = data.frame(smooth_pseudos[[1]])
names(smooth_pseudos1)=c("smooth_pseudos")
pseudos = pseudos[[1]]

pseudo_vals_overall <- data.frame(
  obs = smooth_pseudos1$smooth_pseudos, 
  risk = pseudos$risk,
  Category = "Overall")

Sys.time()-start_time

```


###### Plot

```{r}

pdf("PseudoCal_5yearBenchmark.pdf")

pseudo_vals_overall %>%
  ggplot(aes(x = risk, y = obs)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2) +
  geom_line() +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed outcome proportions") -> p1


print(p1)
dev.off()

five_year_cal_data = pseudo_vals_overall

```

###### Intercept and slope

```{r}

## Calibration intercept and slope --------------------------------------
# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)

# Note:
# - 'pseudos' is the data.frame with ACTUAL pseudo-observations, not the smoothed ones
# - Column ID is not the id in vdata; it is just a number assigned to each row of
# the original validation data sorted by time and event indicator
pseudos$cll_pred <- log(-log(1 - pseudos$risk)) # add the cloglog risk ests

# Fit model for calibration intercept
fit_cal_int <- geese(
  pseudovalue ~ offset(cll_pred),
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Fit model for calibration slope
fit_cal_slope <- geese(
  pseudovalue ~ offset(cll_pred) + cll_pred,
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Perform joint test on intercept and slope
betas <- fit_cal_slope$beta
vcov_mat <- fit_cal_slope$vbeta
wald <- drop(betas %*% solve(vcov_mat) %*% betas)
# pchisq(wald, df = 2, lower.tail = FALSE)
```




```{r}

k <- 3
res_cal <- rbind(

  # Value, confidence interval and test for calibration intercept
  "Intercept" = with(
    summary(fit_cal_int)$mean,
    c(
      "estimate" = estimate,
      `2.5 %` = estimate - qnorm(0.975) * san.se,
      `97.5 %` = estimate + qnorm(0.975) * san.se
    )
  ),

  # Value, confidence interval and test for calibration slope
  "Slope" = with(
    summary(fit_cal_slope)$mean["cll_pred", ],
    c(
      "estimate" = 1 + estimate,
      `2.5 %` = 1 + (estimate - qnorm(0.975) * san.se),
      `97.5 %` = 1 + (estimate + qnorm(0.975) * san.se)
    )
  )
)
res_cal_5years <- round(res_cal, k)

write.csv(res_cal_5years,"res_cal_5years.csv")

res_cal_5years

```


###### Observed/Expected ratio 

```{r}
## Observed/Expected ratio --------------------------------------------
# First calculate Aalen-Johansen estimate (as 'observed')
sf <- survfit(Surv(time, status, type = "mstate") ~ 1, data = vdata)
obj <- summary(sf, times = horizon)


aj <- list(
  "obs" = obj$pstate[, primary_event + 1],
  "se" = obj$std.err[, primary_event + 1]
)

# Calculate O/E
OE <- aj$obs / mean(pred)

# For the confidence interval we use method proposed in Debray et al. (2017) doi:10.1136/bmj.i6460
k <- 3
alpha <- 0.05
OE_summary <- base::cbind(
  "estimate" = OE,
  `2.5 %` = exp(log(OE) - qnorm(1 - alpha / 2) * aj$se / aj$obs),
  `97.5 %` = exp(log(OE) + qnorm(1 - alpha / 2) * aj$se / aj$obs))


OE_summary <- base::round(OE_summary, k)

rownames(OE_summary) <- "O/E ratio"

write.csv(OE_summary,"OE_summary_5yrs_benchmark.csv")

OE_summary_5years = OE_summary

```




#### Combined calibration plot 

##### All predicted and observed risk

```{r}

two_year_cal_data$Time = "2 years"
two_year_cal_data$Model = "Benchmark"

five_year_cal_data$Time = "5 years"
five_year_cal_data$Model = "Benchmark"

benchmark_cal_plot_data = rbind(two_year_cal_data,five_year_cal_data)

saveRDS(benchmark_cal_plot_data,"benchmark_cal_plot_data_pseudo_values.rds")


p1=ggplot(benchmark_cal_plot_data,aes(x = risk, y = obs,color=Model)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed outcome proportions")+
  facet_wrap(~Time)+
  theme(text = element_text(size=50,face="bold",hjust = 0.5),
        axis.title=element_text(size=50,face="bold"),
        axis.text.x = element_text(angle=45, hjust=1,vjust = 1,size = 50),
        axis.text.y = element_text(size = 50),
        axis.text=element_text(size=50))


ggsave(p1,filename = "Benchmark_Combined_Plots.jpeg",width = 35,height = 15, dpi=300)
ggsave(p1,filename = "Benchmark_Combined_Plots.pdf",width = 35,height = 15, dpi=300)

```


##### Restricted to predicted and observed risk below 0.5

```{r}

p1=ggplot(benchmark_cal_plot_data,aes(x = risk, y = obs,color=Model)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 0.5)) +
  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 0.5)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed outcome proportions")+
  facet_wrap(~Time)+
  theme(text = element_text(size=50,face="bold",hjust = 0.5),
        axis.title=element_text(size=50,face="bold"),
        axis.text.x = element_text(angle=45, hjust=1,vjust = 1,size = 50),
        axis.text.y = element_text(size = 50),
        axis.text=element_text(size=50))


ggsave(p1,filename = "Benchmark_Combined_Plots_Restricted.jpeg",width = 35,height = 15, dpi=300)

ggsave(p1,filename = "Benchmark_Combined_Plots_Restricted.pdf",width = 35,height = 15, dpi=300)

```

##### Restricted to predicted and observed risk below 0.1

```{r}

p1=ggplot(benchmark_cal_plot_data,aes(x = risk, y = obs,color=Model)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0, 1, 0.05), limits = c(0, 0.1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.05), limits = c(0, 0.1)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed outcome proportions")+
  facet_wrap(~Time)+
  theme(text = element_text(size=50,face="bold",hjust = 0.5),
        axis.title=element_text(size=50,face="bold"),
        axis.text.x = element_text(angle=45, hjust=1,vjust = 1,size = 50),
        axis.text.y = element_text(size = 50),
        axis.text=element_text(size=50))


ggsave(p1,filename = "Benchmark_Combined_Plots_Restricted2.jpeg",width = 35,height = 15, dpi=300)

ggsave(p1,filename = "Benchmark_Combined_Plots_Restricted2.pdf",width = 35,height = 15, dpi=300)

```



#### Combined calibration slope and Intercept

```{r}

res_cal_5years = data.frame(res_cal_5years)
res_cal_5years = rownames_to_column(res_cal_5years, var = "Metric")
res_cal_5years$Time = "5 years"
res_cal_5years$Model = "Benchmark"

res_cal_2years = data.frame(res_cal_2years)
res_cal_2years = rownames_to_column(res_cal_2years, var = "Metric")
res_cal_2years$Time = "2 years"
res_cal_2years$Model = "Benchmark"

OE_summary_5years = data.frame(OE_summary_5years)
OE_summary_5years = rownames_to_column(OE_summary_5years, var = "Metric")
OE_summary_5years$Time = "5 years"
OE_summary_5years$Model = "Benchmark"

OE_summary_2years = data.frame(OE_summary_2years)
OE_summary_2years = rownames_to_column(OE_summary_2years, var = "Metric")
OE_summary_2years$Time = "2 years"
OE_summary_2years$Model = "Benchmark"

cal_metrics_benchmark = rbind(res_cal_5years,res_cal_2years,
                              
                              OE_summary_5years,OE_summary_2years)

cal_metrics_benchmark$"Metric estimate (95% CI)" = ifelse(is.na(cal_metrics_benchmark$estimate), "",
                             sprintf("%.3f (%.3f to %.3f)",
                                     cal_metrics_benchmark$estimate, cal_metrics_benchmark$X2.5.., cal_metrics_benchmark$X97.5..))

cal_metrics_benchmark = cal_metrics_benchmark[,c(1,5:7)]
saveRDS(cal_metrics_benchmark,"Calibration_summary_stats_Benchmark.rds")

```


## 2. KFREUK1 model


```{r}
start_time0 = Sys.time()
```


#### Calculating the risk scores using the KFREUK1 model

```{r}

kfre_uk1 = readRDS("/rds/projects/s/subramaa-mum-predict/SteveW/KFRE/Final dataset/GOLD data September 2024/KFRE UK models/Calibration/Linked data/KFRE UK 1/IMPUTED/gold_imputed_data_ready_for_validation_kfreuk1.rds")

kfre_uk1 = subset(kfre_uk1,kfre_uk1$diabetic==0)


kfre_only_model = readRDS("/rds/projects/s/subramaa-mum-predict/SteveW/KFRE/Final dataset/Updated data October/15 months ACR Imputed/October 2024/Updated models/2026/model_info_updated_kfre_only.rds")

kfre_only_full_model = readRDS("/rds/projects/s/subramaa-mum-predict/SteveW/KFRE/Final dataset/Updated data October/15 months ACR Imputed/October 2024/Updated models/2026/model_full_updated_kfre_only.rds")



kfre_uk1 = kfre_uk1 %>% dplyr::mutate(

  male=ifelse(female== 0, 1, 0),
    acr1 = ACR_value/100,
    acr2 = log(ACR_value/100),
  age1 = (Age2/100)^-1,
  age2 = (Age2/100)^3,
  eGFR1 = log(EGFR2/100),
  eGFR2 = (EGFR2/100)^0.5,
  patient_id = PRACTICE_PATIENT_ID)


kfre_uk1$LP = predict(kfre_only_full_model$models$`Cause 1`,newdata = kfre_uk1, type = "lp")

kfre_uk1$score_2yrs_KFREUK1 <- riskRegression::predictRisk(
  kfre_only_full_model,
  cause = 1,
  newdata = kfre_uk1,
  times = 2)

kfre_uk1$score_5yrs_KFREUK1 <- riskRegression::predictRisk(
  kfre_only_full_model,
  cause = 1,
  newdata = kfre_uk1,
  times = 5)



kfre_uk1 = kfre_uk1 %>% dplyr::select(
  patient_id,
  time1,status1,
  LP,
  score_2yrs_KFREUK1,
  score_5yrs_KFREUK1)

x = kfre_uk1

```

##### 2 years

```{r}

start_time = Sys.time()

# Calibration plot (pseudo-obs approach) ----------------------------------
# First compute riskRegression::Score()

vdata <- x %>% 
  dplyr::select(patient_id, score_2yrs_KFREUK1, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 2
pred <- as.matrix(vdata$pred)


score_vdata <- riskRegression::Score(
  list("KFRE_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  #  metrics = c("auc", "brier"),
  summary = c("ipa"),
  cause = primary_event,
  plots = "calibration"
)

# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)
pseudos <- pseudos[order(pseudos$risk), ]

library(parallel)
pseudos = list(pseudos)
smooth_pseudos = mclapply(pseudos, function(x){
  smooth_pseudos <- predict(stats::loess(pseudovalue ~ risk, data = x,  span=0.33, degree = 1), se = F)
},mc.cores = 50)
# Use linear loess (weighted local regression with polynomial span=0.25, degree = 1) smoothing
#smooth_pseudos <- predict(stats::loess(pseudovalue ~ risk, data = pseudos,span = 0.25, span=0.25, degree = 1), se = F)

smooth_pseudos1 = data.frame(smooth_pseudos[[1]])
names(smooth_pseudos1)=c("smooth_pseudos")
pseudos = pseudos[[1]]

pseudo_vals_overall <- data.frame(
  obs = smooth_pseudos1$smooth_pseudos, 
  risk = pseudos$risk,
  Category = "Overall")

Sys.time()-start_time

```


###### Plot

```{r}
pdf("PseudoCal_2yearKFREUK1.pdf")

pseudo_vals_overall %>%
  ggplot(aes(x = risk, y = obs)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2) +
  geom_line() +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed outcome proportions") -> p1


print(p1)
dev.off()

two_year_cal_data = pseudo_vals_overall

```


###### Intercept and slope

```{r}

## Calibration intercept and slope --------------------------------------
# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)

# Note:
# - 'pseudos' is the data.frame with ACTUAL pseudo-observations, not the smoothed ones
# - Column ID is not the id in vdata; it is just a number assigned to each row of
# the original validation data sorted by time and event indicator
pseudos$cll_pred <- log(-log(1 - pseudos$risk)) # add the cloglog risk ests

# Fit model for calibration intercept
fit_cal_int <- geese(
  pseudovalue ~ offset(cll_pred),
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Fit model for calibration slope
fit_cal_slope <- geese(
  pseudovalue ~ offset(cll_pred) + cll_pred,
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Perform joint test on intercept and slope
betas <- fit_cal_slope$beta
vcov_mat <- fit_cal_slope$vbeta
wald <- drop(betas %*% solve(vcov_mat) %*% betas)
# pchisq(wald, df = 2, lower.tail = FALSE)
```




```{r}

k <- 3
res_cal <- rbind(

  # Value, confidence interval and test for calibration intercept
  "Intercept" = with(
    summary(fit_cal_int)$mean,
    c(
      "estimate" = estimate,
      `2.5 %` = estimate - qnorm(0.975) * san.se,
      `97.5 %` = estimate + qnorm(0.975) * san.se
    )
  ),

  # Value, confidence interval and test for calibration slope
  "Slope" = with(
    summary(fit_cal_slope)$mean["cll_pred", ],
    c(
      "estimate" = 1 + estimate,
      `2.5 %` = 1 + (estimate - qnorm(0.975) * san.se),
      `97.5 %` = 1 + (estimate + qnorm(0.975) * san.se)
    )
  )
)

res_cal_2years <- round(res_cal, k)

write.csv(res_cal_2years,"res_cal_2years.csv")
res_cal_2years


```


###### Observed/Expected ratio 

```{r}
## Observed/Expected ratio --------------------------------------------
# First calculate Aalen-Johansen estimate (as 'observed')
sf <- survfit(Surv(time, status, type = "mstate") ~ 1, data = vdata)
obj <- summary(sf, times = horizon)


aj <- list(
  "obs" = obj$pstate[, primary_event + 1],
  "se" = obj$std.err[, primary_event + 1]
)

# Calculate O/E
OE <- aj$obs / mean(pred)

# For the confidence interval we use method proposed in Debray et al. (2017) doi:10.1136/bmj.i6460
k <- 3
alpha <- 0.05
OE_summary <- base::cbind(
  "estimate" = OE,
  `2.5 %` = exp(log(OE) - qnorm(1 - alpha / 2) * aj$se / aj$obs),
  `97.5 %` = exp(log(OE) + qnorm(1 - alpha / 2) * aj$se / aj$obs))

OE_summary <- base::round(OE_summary, k)

rownames(OE_summary) <- "O/E ratio"

write.csv(OE_summary,"OE_summary_2yrs_kfreonly.csv")

OE_summary_2years = OE_summary

```





##### 5 years

```{r}

start_time = Sys.time()

# Calibration plot (pseudo-obs approach) ----------------------------------
# First compute riskRegression::Score()

vdata <- x %>% 
  dplyr::select(patient_id, score_5yrs_KFREUK1, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 5
pred <- as.matrix(vdata$pred)


score_vdata <- riskRegression::Score(
  list("KFRE_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  #  metrics = c("auc", "brier"),
  summary = c("ipa"),
  cause = primary_event,
  plots = "calibration"
)

# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)
pseudos <- pseudos[order(pseudos$risk), ]


pseudos = list(pseudos)
smooth_pseudos = mclapply(pseudos, function(x){
  smooth_pseudos <- predict(stats::loess(pseudovalue ~ risk, data = x,  span=0.33, degree = 1), se = F)
},mc.cores = 50)
# Use linear loess (weighted local regression with polynomial span=0.25, degree = 1) smoothing
#smooth_pseudos <- predict(stats::loess(pseudovalue ~ risk, data = pseudos,span = 0.25, span=0.25, degree = 1), se = F)

smooth_pseudos1 = data.frame(smooth_pseudos[[1]])
names(smooth_pseudos1)=c("smooth_pseudos")
pseudos = pseudos[[1]]

pseudo_vals_overall <- data.frame(
  obs = smooth_pseudos1$smooth_pseudos, 
  risk = pseudos$risk,
  Category = "Overall")

Sys.time()-start_time

```


###### Plot

```{r}

pdf("PseudoCal_5yearKFREUK1.pdf")

pseudo_vals_overall %>%
  ggplot(aes(x = risk, y = obs)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2) +
  geom_line() +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed outcome proportions") -> p1


print(p1)
dev.off()

five_year_cal_data = pseudo_vals_overall

```

###### Intercept and slope

```{r}

## Calibration intercept and slope --------------------------------------
# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)

# Note:
# - 'pseudos' is the data.frame with ACTUAL pseudo-observations, not the smoothed ones
# - Column ID is not the id in vdata; it is just a number assigned to each row of
# the original validation data sorted by time and event indicator
pseudos$cll_pred <- log(-log(1 - pseudos$risk)) # add the cloglog risk ests

# Fit model for calibration intercept
fit_cal_int <- geese(
  pseudovalue ~ offset(cll_pred),
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Fit model for calibration slope
fit_cal_slope <- geese(
  pseudovalue ~ offset(cll_pred) + cll_pred,
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Perform joint test on intercept and slope
betas <- fit_cal_slope$beta
vcov_mat <- fit_cal_slope$vbeta
wald <- drop(betas %*% solve(vcov_mat) %*% betas)
# pchisq(wald, df = 2, lower.tail = FALSE)
```




```{r}

k <- 3
res_cal <- rbind(

  # Value, confidence interval and test for calibration intercept
  "Intercept" = with(
    summary(fit_cal_int)$mean,
    c(
      "estimate" = estimate,
      `2.5 %` = estimate - qnorm(0.975) * san.se,
      `97.5 %` = estimate + qnorm(0.975) * san.se
    )
  ),

  # Value, confidence interval and test for calibration slope
  "Slope" = with(
    summary(fit_cal_slope)$mean["cll_pred", ],
    c(
      "estimate" = 1 + estimate,
      `2.5 %` = 1 + (estimate - qnorm(0.975) * san.se),
      `97.5 %` = 1 + (estimate + qnorm(0.975) * san.se)
    )
  )
)
res_cal_5years <- round(res_cal, k)

write.csv(res_cal_5years,"res_cal_5years.csv")

res_cal_5years

```


###### Observed/Expected ratio 

```{r}
## Observed/Expected ratio --------------------------------------------
# First calculate Aalen-Johansen estimate (as 'observed')
sf <- survfit(Surv(time, status, type = "mstate") ~ 1, data = vdata)
obj <- summary(sf, times = horizon)

aj <- list(
  "obs" = obj$pstate[, primary_event + 1],
  "se" = obj$std.err[, primary_event + 1]
)

# Calculate O/E
OE <- aj$obs / mean(pred)

# For the confidence interval we use method proposed in Debray et al. (2017) doi:10.1136/bmj.i6460
k <- 3
alpha <- 0.05
OE_summary <- base::cbind(
  "estimate" = OE,
  `2.5 %` = exp(log(OE) - qnorm(1 - alpha / 2) * aj$se / aj$obs),
  `97.5 %` = exp(log(OE) + qnorm(1 - alpha / 2) * aj$se / aj$obs))

OE_summary <- base::round(OE_summary, k)

rownames(OE_summary) <- "O/E ratio"

write.csv(OE_summary,"OE_summary_5yrs_kfreonly.csv")

OE_summary_5years = OE_summary


```



#### Combined calibration plot 

##### All predicted and observed risk

```{r}

two_year_cal_data$Time = "2 years"
two_year_cal_data$Model = "KFREUK1"

five_year_cal_data$Time = "5 years"
five_year_cal_data$Model = "KFREUK1"

KFREUK1_cal_plot_data = rbind(two_year_cal_data,five_year_cal_data)

saveRDS(KFREUK1_cal_plot_data,"KFREUK1_cal_plot_data_pseudo_values.rds")


p1=ggplot(KFREUK1_cal_plot_data,aes(x = risk, y = obs,color=Model)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed outcome proportions")+
  facet_wrap(~Time)+
  theme(text = element_text(size=50,face="bold",hjust = 0.5),
        axis.title=element_text(size=50,face="bold"),
        axis.text.x = element_text(angle=45, hjust=1,vjust = 1,size = 50),
        axis.text.y = element_text(size = 50),
        axis.text=element_text(size=50))


ggsave(p1,filename = "KFREUK1_Combined_Plots.jpeg",width = 35,height = 15, dpi=300)
ggsave(p1,filename = "KFREUK1_Combined_Plots.pdf",width = 35,height = 15, dpi=300)

```


##### Restricted to predicted and observed risk below 0.5

```{r}

p1=ggplot(KFREUK1_cal_plot_data,aes(x = risk, y = obs,color=Model)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 0.5)) +
  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 0.5)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed outcome proportions")+
  facet_wrap(~Time)+
  theme(text = element_text(size=50,face="bold",hjust = 0.5),
        axis.title=element_text(size=50,face="bold"),
        axis.text.x = element_text(angle=45, hjust=1,vjust = 1,size = 50),
        axis.text.y = element_text(size = 50),
        axis.text=element_text(size=50))


ggsave(p1,filename = "KFREUK1_Combined_Plots_Restricted.jpeg",width = 35,height = 15, dpi=300)

ggsave(p1,filename = "KFREUK1_Combined_Plots_Restricted.pdf",width = 35,height = 15, dpi=300)

```

##### Restricted to predicted and observed risk below 0.1

```{r}

p1=ggplot(KFREUK1_cal_plot_data,aes(x = risk, y = obs,color=Model)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0, 1, 0.05), limits = c(0, 0.1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.05), limits = c(0, 0.1)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed outcome proportions")+
  facet_wrap(~Time)+
  theme(text = element_text(size=50,face="bold",hjust = 0.5),
        axis.title=element_text(size=50,face="bold"),
        axis.text.x = element_text(angle=45, hjust=1,vjust = 1,size = 50),
        axis.text.y = element_text(size = 50),
        axis.text=element_text(size=50))


ggsave(p1,filename = "KFREUK1_Combined_Plots_Restricted2.jpeg",width = 35,height = 15, dpi=300)

ggsave(p1,filename = "KFREUK1_Combined_Plots_Restricted2.pdf",width = 35,height = 15, dpi=300)

```



#### Combined calibration slope and Intercept

```{r}

res_cal_5years = data.frame(res_cal_5years)
res_cal_5years = rownames_to_column(res_cal_5years, var = "Metric")
res_cal_5years$Time = "5 years"
res_cal_5years$Model = "KFREUK1"

res_cal_2years = data.frame(res_cal_2years)
res_cal_2years = rownames_to_column(res_cal_2years, var = "Metric")
res_cal_2years$Time = "2 years"
res_cal_2years$Model = "KFREUK1"

OE_summary_5years = data.frame(OE_summary_5years)
OE_summary_5years = rownames_to_column(OE_summary_5years, var = "Metric")
OE_summary_5years$Time = "5 years"
OE_summary_5years$Model = "Benchmark"

OE_summary_2years = data.frame(OE_summary_2years)
OE_summary_2years = rownames_to_column(OE_summary_2years, var = "Metric")
OE_summary_2years$Time = "2 years"
OE_summary_2years$Model = "Benchmark"

cal_metrics_KFREUK1 = rbind(res_cal_5years,res_cal_2years,
                              
                              OE_summary_5years,OE_summary_2years)

cal_metrics_KFREUK1$"Metric estimate (95% CI)" = ifelse(is.na(cal_metrics_KFREUK1$estimate), "",
                             sprintf("%.3f (%.3f to %.3f)",
                                     cal_metrics_KFREUK1$estimate, cal_metrics_KFREUK1$X2.5.., cal_metrics_KFREUK1$X97.5..))

cal_metrics_KFREUK1 = cal_metrics_KFREUK1[,c(1,5:7)]
saveRDS(cal_metrics_KFREUK1,"Calibration_summary_stats_KFREUK1.rds")

```


```{r}
Sys.time()-start_time0
```


## 2. KFREUK2 model

```{r}
start_time0 = Sys.time()
```


#### Calculating the risk scores using the KFREUK2 model

```{r}



kfre_uk2 = readRDS("/rds/projects/s/subramaa-mum-predict/SteveW/KFRE/Final dataset/GOLD data September 2024/KFRE UK models/Calibration/Linked data/KFRE UK 2/gold_imputed_data_ready_for_validation_kfreplus.rds")

kfre2_only_model = readRDS("/rds/projects/s/subramaa-mum-predict/SteveW/KFRE/Final dataset/Updated data October/15 months ACR Imputed/October 2024/Updated models/2026/model_info_updated_kfre_plus.rds")

kfre2_only_full_model = readRDS("/rds/projects/s/subramaa-mum-predict/SteveW/KFRE/Final dataset/Updated data October/15 months ACR Imputed/October 2024/Updated models/2026/model_full_updated_kfre_plus.rds")


kfre_uk2 = kfre_uk2 %>% dplyr::mutate(

  male=ifelse(female== 0, 1, 0),
    acr1 = (ACR_value/100),
    acr2 = log(ACR_value/100),
  age1 = (Age2/100)^-1,
  age2 = (Age2/100)^3,
  eGFR1 = log(EGFR2/100),
  eGFR2 = (EGFR2/100)^0.5,
  
  black_ethnicity = ifelse(ethnicity=="Black",1,0),
  white_ethnicity = ifelse(ethnicity=="White",1,0),
  asian_ethnicity = ifelse(ethnicity=="South Asian",1,0),
  mixed_ethnicity = ifelse(ethnicity=="Mixed race",1,0),
  other_ethnicity = ifelse(ethnicity=="Others",1,0),
  unknown_ethnicity = ifelse(ethnicity=="Unknown",1,0),
  
  patient_id = PRACTICE_PATIENT_ID)

kfre_uk2 = subset(kfre_uk2,kfre_uk2$diabetic==0)

kfre_uk2$LP = predict(kfre2_only_full_model$models$`Cause 1`,newdata = kfre_uk2, type = "lp")

kfre_uk2$score_2yrs_KFREUK2 <- riskRegression::predictRisk(
  kfre2_only_full_model,
  cause = 1,
  newdata = kfre_uk2,
  times = 2)

kfre_uk2$score_5yrs_KFREUK2 <- riskRegression::predictRisk(
  kfre2_only_full_model,
  cause = 1,
  newdata = kfre_uk2,
  times = 5)



kfre_uk2 = kfre_uk2 %>% dplyr::select(
  patient_id,
  time1,status1,
  LP,
  score_2yrs_KFREUK2,
  score_5yrs_KFREUK2)


x = kfre_uk2

```


##### 2 years

```{r}

start_time = Sys.time()

# Calibration plot (pseudo-obs approach) ----------------------------------
# First compute riskRegression::Score()

vdata <- x %>% 
  dplyr::select(patient_id, score_2yrs_KFREUK2, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 2
pred <- as.matrix(vdata$pred)


score_vdata <- riskRegression::Score(
  list("KFRE_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  #  metrics = c("auc", "brier"),
  summary = c("ipa"),
  cause = primary_event,
  plots = "calibration"
)

# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)
pseudos <- pseudos[order(pseudos$risk), ]

library(parallel)
pseudos = list(pseudos)
smooth_pseudos = mclapply(pseudos, function(x){
  smooth_pseudos <- predict(stats::loess(pseudovalue ~ risk, data = x,  span=0.33, degree = 1), se = F)
},mc.cores = 50)
# Use linear loess (weighted local regression with polynomial span=0.25, degree = 1) smoothing
#smooth_pseudos <- predict(stats::loess(pseudovalue ~ risk, data = pseudos,span = 0.25, span=0.25, degree = 1), se = F)

smooth_pseudos1 = data.frame(smooth_pseudos[[1]])
names(smooth_pseudos1)=c("smooth_pseudos")
pseudos = pseudos[[1]]

pseudo_vals_overall <- data.frame(
  obs = smooth_pseudos1$smooth_pseudos, 
  risk = pseudos$risk,
  Category = "Overall")

Sys.time()-start_time

```


###### Plot

```{r}
pdf("PseudoCal_2yearKFREUK2.pdf")

pseudo_vals_overall %>%
  ggplot(aes(x = risk, y = obs)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2) +
  geom_line() +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed outcome proportions") -> p1


print(p1)
dev.off()

two_year_cal_data = pseudo_vals_overall

```


###### Intercept and slope

```{r}

## Calibration intercept and slope --------------------------------------
# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)

# Note:
# - 'pseudos' is the data.frame with ACTUAL pseudo-observations, not the smoothed ones
# - Column ID is not the id in vdata; it is just a number assigned to each row of
# the original validation data sorted by time and event indicator
pseudos$cll_pred <- log(-log(1 - pseudos$risk)) # add the cloglog risk ests

# Fit model for calibration intercept
fit_cal_int <- geese(
  pseudovalue ~ offset(cll_pred),
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Fit model for calibration slope
fit_cal_slope <- geese(
  pseudovalue ~ offset(cll_pred) + cll_pred,
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Perform joint test on intercept and slope
betas <- fit_cal_slope$beta
vcov_mat <- fit_cal_slope$vbeta
wald <- drop(betas %*% solve(vcov_mat) %*% betas)
# pchisq(wald, df = 2, lower.tail = FALSE)
```




```{r}

k <- 3
res_cal <- rbind(

  # Value, confidence interval and test for calibration intercept
  "Intercept" = with(
    summary(fit_cal_int)$mean,
    c(
      "estimate" = estimate,
      `2.5 %` = estimate - qnorm(0.975) * san.se,
      `97.5 %` = estimate + qnorm(0.975) * san.se
    )
  ),

  # Value, confidence interval and test for calibration slope
  "Slope" = with(
    summary(fit_cal_slope)$mean["cll_pred", ],
    c(
      "estimate" = 1 + estimate,
      `2.5 %` = 1 + (estimate - qnorm(0.975) * san.se),
      `97.5 %` = 1 + (estimate + qnorm(0.975) * san.se)
    )
  )
)

res_cal_2years <- round(res_cal, k)

write.csv(res_cal_2years,"res_cal_2years.csv")
res_cal_2years


```


###### Observed/Expected ratio 

```{r}
## Observed/Expected ratio --------------------------------------------
# First calculate Aalen-Johansen estimate (as 'observed')
sf <- survfit(Surv(time, status, type = "mstate") ~ 1, data = vdata)
obj <- summary(sf, times = horizon)

aj <- list(
  "obs" = obj$pstate[, primary_event + 1],
  "se" = obj$std.err[, primary_event + 1]
)

# Calculate O/E
OE <- aj$obs / mean(pred)

# For the confidence interval we use method proposed in Debray et al. (2017) doi:10.1136/bmj.i6460
k <- 3
alpha <- 0.05
OE_summary <- base::cbind(
  "estimate" = OE,
  `2.5 %` = exp(log(OE) - qnorm(1 - alpha / 2) * aj$se / aj$obs),
  `97.5 %` = exp(log(OE) + qnorm(1 - alpha / 2) * aj$se / aj$obs))


OE_summary <- base::round(OE_summary, k)

rownames(OE_summary) <- "O/E ratio"

write.csv(OE_summary,"OE_summary_2yrs_kfreplus.csv")

OE_summary_2years = OE_summary


```





##### 5 years

```{r}

start_time = Sys.time()

# Calibration plot (pseudo-obs approach) ----------------------------------
# First compute riskRegression::Score()

vdata <- x %>% 
  dplyr::select(patient_id, score_5yrs_KFREUK2, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 5
pred <- as.matrix(vdata$pred)


score_vdata <- riskRegression::Score(
  list("KFRE_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  #  metrics = c("auc", "brier"),
  summary = c("ipa"),
  cause = primary_event,
  plots = "calibration"
)

# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)
pseudos <- pseudos[order(pseudos$risk), ]


pseudos = list(pseudos)
smooth_pseudos = mclapply(pseudos, function(x){
  smooth_pseudos <- predict(stats::loess(pseudovalue ~ risk, data = x,  span=0.33, degree = 1), se = F)
},mc.cores = 50)
# Use linear loess (weighted local regression with polynomial span=0.25, degree = 1) smoothing
#smooth_pseudos <- predict(stats::loess(pseudovalue ~ risk, data = pseudos,span = 0.25, span=0.25, degree = 1), se = F)

smooth_pseudos1 = data.frame(smooth_pseudos[[1]])
names(smooth_pseudos1)=c("smooth_pseudos")
pseudos = pseudos[[1]]

pseudo_vals_overall <- data.frame(
  obs = smooth_pseudos1$smooth_pseudos, 
  risk = pseudos$risk,
  Category = "Overall")

Sys.time()-start_time

```


###### Plot

```{r}

pdf("PseudoCal_5yearKFREUK2.pdf")

pseudo_vals_overall %>%
  ggplot(aes(x = risk, y = obs)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2) +
  geom_line() +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed outcome proportions") -> p1


print(p1)
dev.off()

five_year_cal_data = pseudo_vals_overall

```

###### Intercept and slope

```{r}

## Calibration intercept and slope --------------------------------------
# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)

# Note:
# - 'pseudos' is the data.frame with ACTUAL pseudo-observations, not the smoothed ones
# - Column ID is not the id in vdata; it is just a number assigned to each row of
# the original validation data sorted by time and event indicator
pseudos$cll_pred <- log(-log(1 - pseudos$risk)) # add the cloglog risk ests

# Fit model for calibration intercept
fit_cal_int <- geese(
  pseudovalue ~ offset(cll_pred),
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Fit model for calibration slope
fit_cal_slope <- geese(
  pseudovalue ~ offset(cll_pred) + cll_pred,
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Perform joint test on intercept and slope
betas <- fit_cal_slope$beta
vcov_mat <- fit_cal_slope$vbeta
wald <- drop(betas %*% solve(vcov_mat) %*% betas)
# pchisq(wald, df = 2, lower.tail = FALSE)
```




```{r}

k <- 3
res_cal <- rbind(

  # Value, confidence interval and test for calibration intercept
  "Intercept" = with(
    summary(fit_cal_int)$mean,
    c(
      "estimate" = estimate,
      `2.5 %` = estimate - qnorm(0.975) * san.se,
      `97.5 %` = estimate + qnorm(0.975) * san.se
    )
  ),

  # Value, confidence interval and test for calibration slope
  "Slope" = with(
    summary(fit_cal_slope)$mean["cll_pred", ],
    c(
      "estimate" = 1 + estimate,
      `2.5 %` = 1 + (estimate - qnorm(0.975) * san.se),
      `97.5 %` = 1 + (estimate + qnorm(0.975) * san.se)
    )
  )
)
res_cal_5years <- round(res_cal, k)

write.csv(res_cal_5years,"res_cal_5years.csv")

res_cal_5years

```


###### Observed/Expected ratio 

```{r}
## Observed/Expected ratio --------------------------------------------
# First calculate Aalen-Johansen estimate (as 'observed')
sf <- survfit(Surv(time, status, type = "mstate") ~ 1, data = vdata)
obj <- summary(sf, times = horizon)


aj <- list(
  "obs" = obj$pstate[, primary_event + 1],
  "se" = obj$std.err[, primary_event + 1]
)

# Calculate O/E
OE <- aj$obs / mean(pred)

# For the confidence interval we use method proposed in Debray et al. (2017) doi:10.1136/bmj.i6460
k <- 3
alpha <- 0.05
OE_summary <- base::cbind(
  "estimate" = OE,
  `2.5 %` = exp(log(OE) - qnorm(1 - alpha / 2) * aj$se / aj$obs),
  `97.5 %` = exp(log(OE) + qnorm(1 - alpha / 2) * aj$se / aj$obs))


OE_summary <- base::round(OE_summary, k)

rownames(OE_summary) <- "O/E ratio"

write.csv(OE_summary,"OE_summary_5yrs_kfreplus.csv")

OE_summary_5years = OE_summary

```






#### Combined calibration plot 

##### All predicted and observed risk

```{r}

two_year_cal_data$Time = "2 years"
two_year_cal_data$Model = "KFREUK2"

five_year_cal_data$Time = "5 years"
five_year_cal_data$Model = "KFREUK2"

KFREUK2_cal_plot_data = rbind(two_year_cal_data,five_year_cal_data)

saveRDS(KFREUK2_cal_plot_data,"KFREUK2_cal_plot_data_pseudo_values.rds")


p1=ggplot(KFREUK2_cal_plot_data,aes(x = risk, y = obs,color=Model)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed outcome proportions")+
  facet_wrap(~Time)+
  theme(text = element_text(size=50,face="bold",hjust = 0.5),
        axis.title=element_text(size=50,face="bold"),
        axis.text.x = element_text(angle=45, hjust=1,vjust = 1,size = 50),
        axis.text.y = element_text(size = 50),
        axis.text=element_text(size=50))


ggsave(p1,filename = "KFREUK2_Combined_Plots.jpeg",width = 35,height = 15, dpi=300)
ggsave(p1,filename = "KFREUK2_Combined_Plots.pdf",width = 35,height = 15, dpi=300)

```


##### Restricted to predicted and observed risk below 0.5

```{r}

p1=ggplot(KFREUK2_cal_plot_data,aes(x = risk, y = obs,color=Model)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 0.5)) +
  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 0.5)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed outcome proportions")+
  facet_wrap(~Time)+
  theme(text = element_text(size=50,face="bold",hjust = 0.5),
        axis.title=element_text(size=50,face="bold"),
        axis.text.x = element_text(angle=45, hjust=1,vjust = 1,size = 50),
        axis.text.y = element_text(size = 50),
        axis.text=element_text(size=50))


ggsave(p1,filename = "KFREUK2_Combined_Plots_Restricted.jpeg",width = 35,height = 15, dpi=300)

ggsave(p1,filename = "KFREUK2_Combined_Plots_Restricted.pdf",width = 35,height = 15, dpi=300)

```

##### Restricted to predicted and observed risk below 0.1

```{r}

p1=ggplot(KFREUK2_cal_plot_data,aes(x = risk, y = obs,color=Model)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0, 1, 0.05), limits = c(0, 0.1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.05), limits = c(0, 0.1)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed outcome proportions")+
  facet_wrap(~Time)+
  theme(text = element_text(size=50,face="bold",hjust = 0.5),
        axis.title=element_text(size=50,face="bold"),
        axis.text.x = element_text(angle=45, hjust=1,vjust = 1,size = 50),
        axis.text.y = element_text(size = 50),
        axis.text=element_text(size=50))


ggsave(p1,filename = "KFREUK2_Combined_Plots_Restricted2.jpeg",width = 35,height = 15, dpi=300)

ggsave(p1,filename = "KFREUK2_Combined_Plots_Restricted2.pdf",width = 35,height = 15, dpi=300)

```



#### Combined calibration slope and Intercept

```{r}

res_cal_5years = data.frame(res_cal_5years)
res_cal_5years = rownames_to_column(res_cal_5years, var = "Metric")
res_cal_5years$Time = "5 years"
res_cal_5years$Model = "KFREUK2"

res_cal_2years = data.frame(res_cal_2years)
res_cal_2years = rownames_to_column(res_cal_2years, var = "Metric")
res_cal_2years$Time = "2 years"
res_cal_2years$Model = "KFREUK2"

OE_summary_5years = data.frame(OE_summary_5years)
OE_summary_5years = rownames_to_column(OE_summary_5years, var = "Metric")
OE_summary_5years$Time = "5 years"
OE_summary_5years$Model = "Benchmark"

OE_summary_2years = data.frame(OE_summary_2years)
OE_summary_2years = rownames_to_column(OE_summary_2years, var = "Metric")
OE_summary_2years$Time = "2 years"
OE_summary_2years$Model = "Benchmark"

cal_metrics_KFREUK2 = rbind(res_cal_5years,res_cal_2years,
                              
                              OE_summary_5years,OE_summary_2years)

cal_metrics_KFREUK2$"Metric estimate (95% CI)" = ifelse(is.na(cal_metrics_KFREUK2$estimate), "",
                             sprintf("%.3f (%.3f to %.3f)",
                                     cal_metrics_KFREUK2$estimate, cal_metrics_KFREUK2$X2.5.., cal_metrics_KFREUK2$X97.5..))

cal_metrics_KFREUK2 = cal_metrics_KFREUK2[,c(1,5:7)]
saveRDS(cal_metrics_KFREUK2,"Calibration_summary_stats_KFREUK2.rds")

```


```{r}
Sys.time()-start_time0
```




## 5. Combine calibration plots  all models

```{r}

benchmark_cal_data = readRDS("benchmark_cal_plot_data_pseudo_values.rds")
benchmark_cal_data$Model = "Current KFRE"

kfreuk1_cal_data = readRDS("KFREUK1_cal_plot_data_pseudo_values.rds")
kfreuk1_cal_data$Model = "KFRE UK"

kfreuk2_cal_data = readRDS("KFREUK2_cal_plot_data_pseudo_values.rds")
kfreuk2_cal_data$Model = "KFRE UK Plus"

combined_cal_data = rbind(benchmark_cal_data,kfreuk1_cal_data,kfreuk2_cal_data)

combined_cal_data = combined_cal_data %>% dplyr::mutate(
  
  Model2 = recode(Model, "Current KFRE"="Current KFRE","KFRE UK"="KFRE UK","KFRE UK Plus"="KFRE UK Plus"),
  
  Model = factor(Model2,levels = c("Current KFRE","KFRE UK","KFRE UK Plus"))
)

```


### 2 years

#### All predicted and observed risks

```{r}

combined_cal_data_2yrs = subset(combined_cal_data,combined_cal_data$Time=="2 years")

p1=ggplot(combined_cal_data_2yrs,aes(x = risk, y = obs,color=Model)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed risks")+
  facet_wrap(~Model)+
  theme(text = element_text(size=50,face="bold",hjust = 0.5),
        axis.title=element_text(size=50,face="bold"),
        axis.text.x = element_text(angle=45, hjust=1,vjust = 1,size = 50),
        axis.text.y = element_text(size = 50),
        axis.text=element_text(size=50), legend.position = "blank")

plot_2yrs_full = p1
  
ggsave(p1,filename = "Final_Combined_2years_Plots.jpeg",width = 45,height = 20, dpi=300)
ggsave(p1,filename = "Final_Combined_2years_Plots.pdf",width = 45,height = 20, dpi=300)


```

#### Restrict to 0.5

```{r}
p1=ggplot(combined_cal_data_2yrs,aes(x = risk, y = obs,color=Model)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0, 0.5, 0.1), limits = c(0, 0.5)) +
  scale_x_continuous(breaks = seq(0, 0.5, 0.1), limits = c(0, 0.5)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed risks")+
  facet_wrap(~Model)+
  theme(text = element_text(size=50,face="bold",hjust = 0.5),
        axis.title=element_text(size=50,face="bold"),
        axis.text.x = element_text(angle=45, hjust=1,vjust = 1,size = 50),
        axis.text.y = element_text(size = 50),
        axis.text=element_text(size=50), legend.position = "blank")

plot_2yrs_restricted = p1

ggsave(p1,filename = "Final_Combined_2years_PlotsRestricted.jpeg",width = 45,height = 20, dpi=300)
ggsave(p1,filename = "Final_Combined_2years_PlotsRestricted.pdf",width = 45,height = 20, dpi=300)

```


### 5 years

#### All predicted and observed risks

```{r}

combined_cal_data_5yrs = subset(combined_cal_data,combined_cal_data$Time=="5 years")

p1=ggplot(combined_cal_data_5yrs,aes(x = risk, y = obs,color=Model)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed risks")+
  facet_wrap(~Model)+
  theme(text = element_text(size=50,face="bold",hjust = 0.5),
        axis.title=element_text(size=50,face="bold"),
        axis.text.x = element_text(angle=45, hjust=1,vjust = 1,size = 50),
        axis.text.y = element_text(size = 50),
        axis.text=element_text(size=50), legend.position = "blank")

plot_5yrs_full = p1


ggsave(p1,filename = "Final_Combined_5years_Plots.jpeg",width = 45,height = 20, dpi=300)
ggsave(p1,filename = "Final_Combined_5years_Plots.pdf",width = 45,height = 20, dpi=300)

```


#### Restricted to 0.1

```{r}
p1=ggplot(combined_cal_data_5yrs,aes(x = risk, y = obs,color=Model)) +
  # geom_ribbon(aes(ymin = ll, ymax = ul), fill = "grey90") +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0, 0.1, 0.05), limits = c(0, 0.1)) +
  scale_x_continuous(breaks = seq(0, 0.1, 0.05), limits = c(0, 0.1)) +
  theme_bw() +
  xlab("Predicted risks") +
  ylab("Observed risks")+
  facet_wrap(~Model)+
  theme(text = element_text(size=50,face="bold",hjust = 0.5),
        axis.title=element_text(size=50,face="bold"),
        axis.text.x = element_text(angle=45, hjust=1,vjust = 1,size = 50),
        axis.text.y = element_text(size = 50),
        axis.text=element_text(size=50), legend.position = "blank")

plot_5yrs_restricted = p1


ggsave(p1,filename = "Final_Combined_5years_PlotsRestricted.jpeg",width = 45,height = 20, dpi=300)
ggsave(p1,filename = "Final_Combined_5years_PlotsRestricted.pdf",width = 45,height = 20, dpi=300)


```



### Combine 2 and 5 years plots

#### Full

```{r}

library(cowplot)
library(patchwork)


version1 = (plot_2yrs_full + theme(axis.title.x = element_blank()) + labs(title = "2 years"))/(plot_5yrs_full + labs(title = "5 years"))

ggsave(version1,filename = "Final_Full_Plots.jpeg",width = 49,height = 35, dpi=300)


# version2 = plot_grid(plot_2yrs_full + theme(axis.title.x = element_blank()),plot_5yrs_full,nrow = 2,labels = c("2 year model","5 year model"),label_size = 50,label_fontface = "bold",label_x = 0.02, label_y = 0.98) 
# 
# ggsave(version2,filename = "Final_Full_PlotsV2.jpeg",width = 49,height = 35, dpi=300)



```



#### Restricted

```{r}

version1 = (plot_2yrs_restricted + theme(axis.title.x = element_blank()) + labs(title = "2 years"))/(plot_5yrs_restricted + labs(title = "5 years"))

ggsave(version1,filename = "Final_Restricteda_Plots.jpeg",width = 49,height = 35, dpi=300)




```


### 2 years and 5 years - Version 2

```{r}

#2 years and five years complete plot
combined_cal_data$Time2 = ifelse(combined_cal_data$Time=="2 years","2 years (Full plot)","5 years (Full plot)")
#2 years and five years Restricted to 0.1 for 5 year model and 0.5 for 2 year model
two_year_restricted = subset(combined_cal_data,combined_cal_data$Time=="2 years")
two_year_restricted = subset(two_year_restricted,two_year_restricted$obs<=0.5)
two_year_restricted = subset(two_year_restricted,two_year_restricted$risk<=0.5)

five_year_restricted = subset(combined_cal_data,combined_cal_data$Time=="5 years")
five_year_restricted = subset(five_year_restricted,five_year_restricted$obs<=0.1)
five_year_restricted = subset(five_year_restricted,five_year_restricted$risk<=0.1)

combined_cal_data_restricted = rbind(two_year_restricted,five_year_restricted)
combined_cal_data_restricted$Time2 = ifelse(combined_cal_data_restricted$Time=="2 years","2 years (Restricted plot)","5 years (Restricted plot)")

figure_5_data  = rbind(combined_cal_data,combined_cal_data_restricted)
figure_5_data$Time2 = factor(figure_5_data$Time2,levels = c("2 years (Full plot)","2 years (Restricted plot)",
                                                            "5 years (Full plot)","5 years (Restricted plot)"))

```


### 2 years and 5 years - Greyscale colors

#### 2 year full + restricted

```{r}

figure_5_data1 = subset(figure_5_data,figure_5_data$Time2=="2 years (Full plot)")



ideal_seg_df <- data.frame(
  x = 0, y = 0,
  xend = 1, yend = 1,
  label = "Ideal calibration"
)


p1 = ggplot(figure_5_data1, aes(
  x = risk,
  y = obs,
  group = Model,
  color = Model,
  linetype = Model
)) +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 5) +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  xlab("Predicted risks") +
  ylab("Observed risks") +
  theme_bw() +
  scale_color_manual(values = c(
    "Current KFRE" = "#4D4D4D",  # dark-grey
    "KFRE UK"   = "#56B4E9" ,  # sky blue
    "KFRE UK Plus"   = "#E69F00"  # orange
   
  )) +
  scale_linetype_manual(values = c(
    "Current KFRE" = "dashed",
    "KFRE UK"   = "dotdash",
    "KFRE UK Plus"   = "solid"
  
  )) +
  theme(
    text = element_text(size = 50, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 50, face = "bold"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 50),
    axis.text.y = element_text(size = 50),
    axis.text = element_text(size = 50),
    legend.title = element_text(size = 45, face = "bold"),
    legend.text = element_text(size = 40),
    legend.position = "blank"  # change to "none" if you really want to hide it
  )


ggsave(p1,filename = "Figure_5a_V2.jpeg",width = 45,height = 20, dpi=300)


figure_5_data2 = subset(figure_5_data,figure_5_data$Time2=="2 years (Restricted plot)")

p2 = ggplot(figure_5_data2, aes(
  x = risk,
  y = obs,
  group = Model,
  color = Model,
  linetype = Model
)) +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 5) +
  scale_y_continuous(breaks = seq(0, 0.5, 0.1), limits = c(0, 0.5)) +
  scale_x_continuous(breaks = seq(0, 0.5, 0.1), limits = c(0, 0.5)) +
  xlab("Predicted risks") +
  ylab("Observed risks") +
  theme_bw() +
  scale_color_manual(values = c(
    "Current KFRE" = "#4D4D4D",  # dark-grey
    "KFRE UK"   = "#56B4E9" ,  # sky blue
    "KFRE UK Plus"   = "#E69F00"  # orange
   
  )) +
  scale_linetype_manual(values = c(
    "Current KFRE" = "dashed",
    "KFRE UK"   = "dotdash",
    "KFRE UK Plus"   = "solid"
  
  )) +
  theme(
    text = element_text(size = 50, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 50, face = "bold"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 50),
    axis.text.y = element_text(size = 50),
    axis.text = element_text(size = 50),
    legend.title = element_text(size = 45, face = "bold"),
    legend.text = element_text(size = 40),
    legend.justification = c(1, 1),
    legend.key.width = unit(6, "cm") # change to "none" if you really want to hide it
  )

  
ggsave(p2,filename = "Figure_5b_V2.jpeg",width = 45,height = 20, dpi=300)

library(patchwork)

version1 = (p1 + labs(title = "2 years (Full plot)"))+(p2 + labs(title = "2 years (Restricted plot)"))

ggsave(version1,filename = "Figure_5ab_V2.jpeg",width = 45,height = 20, dpi=300)

```

#### 5 year full + restricted

```{r}

figure_5_data1 = subset(figure_5_data,figure_5_data$Time2=="5 years (Full plot)")

p3 = ggplot(figure_5_data1, aes(
  x = risk,
  y = obs,
  group = Model,
  color = Model,
  linetype = Model
)) +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 5) +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  xlab("Predicted risks") +
  ylab("Observed risks") +
  theme_bw() +
  scale_color_manual(values = c(
    "Current KFRE" = "#4D4D4D",  # dark-grey
    "KFRE UK"   = "#56B4E9" ,  # sky blue
    "KFRE UK Plus"   = "#E69F00"  # orange
   
  )) +
  scale_linetype_manual(values = c(
    "Current KFRE" = "dashed",
    "KFRE UK"   = "dotdash",
    "KFRE UK Plus"   = "solid"
  
  )) +
  theme(
    text = element_text(size = 50, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 50, face = "bold"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 50),
    axis.text.y = element_text(size = 50),
    axis.text = element_text(size = 50),
    legend.title = element_text(size = 45, face = "bold"),
    legend.text = element_text(size = 40),
    legend.position = "blank"  # change to "none" if you really want to hide it
  )

  
ggsave(p3,filename = "Figure_5c_V2.jpeg",width = 45,height = 20, dpi=300)


figure_5_data2 = subset(figure_5_data,figure_5_data$Time2=="5 years (Restricted plot)")

p4 = ggplot(figure_5_data2, aes(
  x = risk,
  y = obs,
  group = Model,
  color = Model,
  linetype = Model
)) +
  geom_abline(intercept = 0, slope = 1, colour = "red", linetype = 2, linewidth = 3) +
  geom_line(linewidth = 5) +
  scale_y_continuous(breaks = seq(0, 0.1, 0.05), limits = c(0, 0.1)) +
  scale_x_continuous(breaks = seq(0, 0.1, 0.05), limits = c(0, 0.1)) +
  xlab("Predicted risks") +
  ylab("Observed risks") +
  theme_bw() +
  scale_color_manual(values = c(
    "Current KFRE" = "#4D4D4D",  # dark-grey
    "KFRE UK"   = "#56B4E9" ,  # sky blue
    "KFRE UK Plus"   = "#E69F00"  # orange
   
  )) +
  scale_linetype_manual(values = c(
    "Current KFRE" = "dashed",
    "KFRE UK"   = "dotdash",
    "KFRE UK Plus"   = "solid"
  
  )) +
  theme(
    text = element_text(size = 50, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 50, face = "bold"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 50),
    axis.text.y = element_text(size = 50),
    axis.text = element_text(size = 50),
    legend.title = element_text(size = 45, face = "bold"),
    legend.text = element_text(size = 40),
    legend.justification = c(1, 1),
    legend.key.width = unit(6, "cm") # change to "none" if you really want to hide it
  )

ggsave(p4,filename = "Figure_5d_V2.jpeg",width = 45,height = 20, dpi=300)

library(patchwork)

version1 = (p3 + labs(title = "5 years (Full plot)"))+(p4 + labs(title = "5 years (Restricted plot)"))

ggsave(version1,filename = "Figure_5cd_V2.jpeg",width = 45,height = 20, dpi=300)


```

##### Combine Figure 5

```{r}

version1 = ((p1 + labs(title = "2 years (Full plot)") + xlab(""))+(p2 + labs(title = "2 years (Restricted plot)")+ xlab("") + ylab("")))/ ((p3 + labs(title = "5 years (Full plot)"))+(p4 + labs(title = "5 years (Restricted plot)") + theme(legend.position = "blank") + ylab("")))

ggsave(version1,filename = "Figure_5_Final_V2.jpeg",width = 47,height = 42.8, dpi=300)

```


### 2 years and 5 years - Greyscale colors

#### 2 year full + restricted

```{r}

figure_5_data1 = subset(figure_5_data,figure_5_data$Time2=="2 years (Full plot)")

ideal_seg_df <- data.frame(
  x = 0, y = 0,
  xend = 1, yend = 1,
  label = "Ideal calibration"
)

p1 = ggplot(figure_5_data1, aes(
  x = risk,
  y = obs,
  group = Model,
  color = Model,
  linetype = Model
))  +
  # Ideal calibration line ONLY between (0,0) and (1,1)
  geom_segment(
    data = ideal_seg_df,
    aes(x = x, y = y, xend = xend, yend = yend,
        color = label, linetype = label),
    inherit.aes = FALSE,
    linewidth = 3,
    key_glyph = ggplot2::draw_key_path
  ) +
  geom_line(linewidth = 5) +
  scale_y_continuous(breaks = seq(0,1,0.2), limits = c(0,1)) +
  scale_x_continuous(breaks = seq(0,1,0.2), limits = c(0,1)) +
  scale_color_manual(
    values = c("Ideal calibration"="red","Current KFRE"="#4D4D4D","KFRE UK"="#56B4E9","KFRE UK Plus"="#E69F00"),
    breaks = c("Ideal calibration","Current KFRE","KFRE UK","KFRE UK Plus")
  ) +
  scale_linetype_manual(
    values = c("Ideal calibration"="dashed","Current KFRE"="dashed","KFRE UK"="dotdash","KFRE UK Plus"="solid"),
    breaks = c("Ideal calibration","Current KFRE","KFRE UK","KFRE UK Plus")
  ) +
  guides(
    color = guide_legend(order = 1),
    linetype = guide_legend(order = 1)
  ) +
  theme_bw() +
  theme(
    text = element_text(size = 50, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 50, face = "bold"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 50),
    axis.text.y = element_text(size = 50),
    axis.text = element_text(size = 50),
    legend.title = element_text(size = 45, face = "bold"),
    legend.text = element_text(size = 40),
    legend.position = "blank"
  )


ggsave(p1,filename = "Figure_5a_V2.jpeg",width = 45,height = 20, dpi=300)


figure_5_data2 = subset(figure_5_data,figure_5_data$Time2=="2 years (Restricted plot)")


ideal_seg_df <- data.frame(
  x = 0, y = 0,
  xend = 0.5, yend = 0.5,
  label = "Ideal calibration"
)

p2 = ggplot(figure_5_data2, aes(
  x = risk,
  y = obs,
  group = Model,
  color = Model,
  linetype = Model
)) +
 # Ideal calibration line ONLY between (0,0) and (1,1)
  geom_segment(
    data = ideal_seg_df,
    aes(x = x, y = y, xend = xend, yend = yend,
        color = label, linetype = label),
    inherit.aes = FALSE,
    linewidth = 3,
    key_glyph = ggplot2::draw_key_path
  ) +
  geom_line(linewidth = 5) +
  scale_y_continuous(breaks = seq(0, 0.5, 0.1), limits = c(0, 0.5)) +
  scale_x_continuous(breaks = seq(0, 0.5, 0.1), limits = c(0, 0.5)) +
  xlab("Predicted probabilities") + ylab("Observed probabilities") +
  theme_bw() +
  scale_color_manual(
    values = c(
      "Ideal calibration" = "red",
      "Current KFRE"  = "#4D4D4D",
      "KFRE UK"    = "#56B4E9",
      "KFRE UK Plus"    = "#E69F00"
    ),
    breaks = c("Ideal calibration","Current KFRE","KFRE UK","KFRE UK Plus")
  ) +
  scale_linetype_manual(
    values = c(
      "Ideal calibration" = "dashed",  # <- use character, not 2
      "Current KFRE"  = "dashed",
      "KFRE UK"    = "dotdash",
      "KFRE UK Plus"    = "solid"
    ),
    breaks = c("Ideal calibration","Current KFRE","KFRE UK","KFRE UK Plus")
  ) +
  guides(
    color = guide_legend(order = 1),
    linetype = guide_legend(order = 1)
  )  +
  theme(
    text = element_text(size = 50, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 50, face = "bold"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 50),
    axis.text.y = element_text(size = 50),
    axis.text = element_text(size = 50),
    legend.title = element_text(size = 45, face = "bold"),
    legend.text = element_text(size = 40),
    legend.justification = c(1, 1),
    legend.key.width = unit(6, "cm") # change to "none" if you really want to hide it
  )

  
ggsave(p2,filename = "Figure_5b_V2.jpeg",width = 45,height = 20, dpi=300)

library(patchwork)

version1 = (p1 + labs(title = "2 years (Full plot)"))+(p2 + labs(title = "2 years (Restricted plot)"))

ggsave(version1,filename = "Figure_5ab_V2.jpeg",width = 45,height = 20, dpi=300)

```

#### 5 year full + restricted

```{r}

figure_5_data1 = subset(figure_5_data,figure_5_data$Time2=="5 years (Full plot)")

ideal_seg_df <- data.frame(
  x = 0, y = 0,
  xend = 1, yend = 1,
  label = "Ideal calibration"
)

p3 = ggplot(figure_5_data1, aes(
  x = risk,
  y = obs,
  group = Model,
  color = Model,
  linetype = Model
)) +
  # Ideal calibration line ONLY between (0,0) and (1,1)
  geom_segment(
    data = ideal_seg_df,
    aes(x = x, y = y, xend = xend, yend = yend,
        color = label, linetype = label),
    inherit.aes = FALSE,
    linewidth = 3,
    key_glyph = ggplot2::draw_key_path
  ) +
  geom_line(linewidth = 5) +
  scale_y_continuous(breaks = seq(0,1,0.2), limits = c(0,1)) +
  scale_x_continuous(breaks = seq(0,1,0.2), limits = c(0,1)) +
  scale_color_manual(
    values = c("Ideal calibration"="red","Current KFRE"="#4D4D4D","KFRE UK"="#56B4E9","KFRE UK Plus"="#E69F00"),
    breaks = c("Ideal calibration","Current KFRE","KFRE UK","KFRE UK Plus")
  ) +
  scale_linetype_manual(
    values = c("Ideal calibration"="dashed","Current KFRE"="dashed","KFRE UK"="dotdash","KFRE UK Plus"="solid"),
    breaks = c("Ideal calibration","Current KFRE","KFRE UK","KFRE UK Plus")
  ) +
  guides(
    color = guide_legend(order = 1),
    linetype = guide_legend(order = 1)
  ) +
  theme_bw() +
  theme(
    text = element_text(size = 50, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 50, face = "bold"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 50),
    axis.text.y = element_text(size = 50),
    axis.text = element_text(size = 50),
    legend.title = element_text(size = 45, face = "bold"),
    legend.text = element_text(size = 40),
    legend.position = "blank"  # change to "none" if you really want to hide it
  )

  
ggsave(p3,filename = "Figure_5c_V2.jpeg",width = 45,height = 20, dpi=300)


figure_5_data2 = subset(figure_5_data,figure_5_data$Time2=="5 years (Restricted plot)")


ideal_seg_df <- data.frame(
  x = 0, y = 0,
  xend = 0.1, yend = 0.1,
  label = "Ideal calibration"
)



p4 = ggplot(figure_5_data2, aes(
  x = risk,
  y = obs,
  group = Model,
  color = Model,
  linetype = Model
))+
  # Ideal calibration line ONLY between (0,0) and (1,1)
  geom_segment(
    data = ideal_seg_df,
    aes(x = x, y = y, xend = xend, yend = yend,
        color = label, linetype = label),
    inherit.aes = FALSE,
    linewidth = 3,
    key_glyph = ggplot2::draw_key_path
  ) +
  geom_line(linewidth = 5) +
  scale_y_continuous(breaks = seq(0, 0.1, 0.05), limits = c(0, 0.1)) +
  scale_x_continuous(breaks = seq(0, 0.1, 0.05), limits = c(0, 0.1)) +
  scale_color_manual(
    values = c("Ideal calibration"="red","Current KFRE"="#4D4D4D","KFRE UK"="#56B4E9","KFRE UK Plus"="#E69F00"),
    breaks = c("Ideal calibration","Current KFRE","KFRE UK","KFRE UK Plus")
  ) +
  scale_linetype_manual(
    values = c("Ideal calibration"="dashed","Current KFRE"="dashed","KFRE UK"="dotdash","KFRE UK Plus"="solid"),
    breaks = c("Ideal calibration","Current KFRE","KFRE UK","KFRE UK Plus")
  ) +
  guides(
    color = guide_legend(order = 1),
    linetype = guide_legend(order = 1)
  ) +
  theme_bw() +
  theme(
    text = element_text(size = 50, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 50, face = "bold"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 50),
    axis.text.y = element_text(size = 50),
    axis.text = element_text(size = 50),
    legend.title = element_text(size = 45, face = "bold"),
    legend.text = element_text(size = 40),
    legend.justification = c(1, 1),
    legend.key.width = unit(6, "cm") # change to "none" if you really want to hide it
  )

ggsave(p4,filename = "Figure_5d_V2.jpeg",width = 45,height = 20, dpi=300)

library(patchwork)

version1 = (p3 + labs(title = "5 years (Full plot)"))+(p4 + labs(title = "5 years (Restricted plot)"))

ggsave(version1,filename = "Figure_5cd_V2.jpeg",width = 45,height = 20, dpi=300)


```

##### Combine Figure 5

```{r}

version1 = ((p1 + labs(title = "2 years (Full plot)") + xlab("") + ylab("Observed probabilities"))+(p2 + labs(title = "2 years (Restricted plot)")+ xlab("") + ylab("")))/ ((p3 + labs(title = "5 years (Full plot)")+ xlab("Predicted probabilities") + ylab("Observed probabilities"))+(p4 + labs(title = "5 years (Restricted plot)") + theme(legend.position = "blank") + ylab("") + xlab("Predicted probabilities")))

ggsave(version1,filename = "Figure_5_Final_V2.jpeg",width = 48.2,height = 42.8, dpi=300)


```


#### 2 year full + restricted (Benchmark)

```{r}

figure_5_data1 = subset(figure_5_data,figure_5_data$Time2=="2 years (Full plot)" & figure_5_data$Model=="Current KFRE")

ideal_line_df <- data.frame(
  slope = 1,
  intercept = 0,
  label = "Ideal calibration"
)

p1 = ggplot(figure_5_data1, aes(
  x = risk,
  y = obs,
  group = Model,
  color = Model,
  linetype = Model
))  +
  geom_abline(
    data = ideal_line_df,
    aes(slope = slope, intercept = intercept,
        color = label, linetype = label),
    linewidth = 3,
    key_glyph = ggplot2::draw_key_path   # <- makes legend line horizontal
  ) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0,1,0.2), limits = c(0,1)) +
  scale_x_continuous(breaks = seq(0,1,0.2), limits = c(0,1)) +
  scale_color_manual(
    values = c("Ideal calibration"="red","Current KFRE"="#56B4E9"),
    breaks = c("Ideal calibration","Current KFRE")
  ) +
  scale_linetype_manual(
    values = c("Ideal calibration"="dashed","Current KFRE"="solid"),
    breaks = c("Ideal calibration","Current KFRE")
  ) +
  guides(
    color = guide_legend(order = 1),
    linetype = guide_legend(order = 1)
  ) +
  theme_bw() +
  theme(
    text = element_text(size = 50, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 50, face = "bold"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 50),
    axis.text.y = element_text(size = 50),
    axis.text = element_text(size = 50),
    legend.title = element_text(size = 45, face = "bold"),
    legend.text = element_text(size = 40),
    legend.position = "blank"
  )


ggsave(p1,filename = "Figure_5a_V2_Benchmark.jpeg",width = 45,height = 20, dpi=300)


figure_5_data2 = subset(figure_5_data,figure_5_data$Time2=="2 years (Restricted plot)" & figure_5_data$Model=="Current KFRE")

p2 = ggplot(figure_5_data2, aes(
  x = risk,
  y = obs,
  group = Model,
  color = Model,
  linetype = Model
)) +
  geom_abline(
    data = ideal_line_df,
    aes(slope = slope, intercept = intercept,
        color = label, linetype = label),
    linewidth = 3,
    key_glyph = ggplot2::draw_key_path
  ) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0, 0.5, 0.1), limits = c(0, 0.5)) +
  scale_x_continuous(breaks = seq(0, 0.5, 0.1), limits = c(0, 0.5)) +
  xlab("Predicted probabilities") + ylab("Observed probabilities") +
  theme_bw() +
  scale_color_manual(
    values = c(
      "Ideal calibration" = "red",
      "Current KFRE"  = "#56B4E9"
    ),
    breaks = c("Ideal calibration","Current KFRE")
  ) +
  scale_linetype_manual(
    values = c(
      "Ideal calibration" = "dashed",  # <- use character, not 2
      "Current KFRE"  = "solid"
    ),
    breaks = c("Ideal calibration","Current KFRE")
  ) +
  guides(
    color = guide_legend(order = 1),
    linetype = guide_legend(order = 1)
  )  +
  theme(
    text = element_text(size = 50, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 50, face = "bold"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 50),
    axis.text.y = element_text(size = 50),
    axis.text = element_text(size = 50),
    legend.title = element_text(size = 45, face = "bold"),
    legend.text = element_text(size = 40),
    legend.justification = c(1, 1),
    legend.key.width = unit(6, "cm") # change to "none" if you really want to hide it
  )

  
ggsave(p2,filename = "Figure_5b_V2_Benchmark.jpeg",width = 45,height = 20, dpi=300)

library(patchwork)

version1 = (p1 + labs(title = "2 years (Full plot)"))+(p2 + labs(title = "2 years (Restricted plot)"))

ggsave(version1,filename = "Figure_5ab_V2_Benchmark.jpeg",width = 45,height = 20, dpi=300)

```

#### 5 year full + restricted (Benchmark)

```{r}

figure_5_data1 = subset(figure_5_data,figure_5_data$Time2=="5 years (Full plot)" & figure_5_data$Model=="Current KFRE")

p3 = ggplot(figure_5_data1, aes(
  x = risk,
  y = obs,
  group = Model,
  color = Model,
  linetype = Model
)) +
  geom_abline(
    data = ideal_line_df,
    aes(slope = slope, intercept = intercept,
        color = label, linetype = label),
    linewidth = 3,
    key_glyph = ggplot2::draw_key_path   # <- makes legend line horizontal
  ) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0,1,0.2), limits = c(0,1)) +
  scale_x_continuous(breaks = seq(0,1,0.2), limits = c(0,1)) +
  scale_color_manual(
    values = c("Ideal calibration"="red","Current KFRE"="#56B4E9"),
    breaks = c("Ideal calibration","Current KFRE")
  ) +
  scale_linetype_manual(
    values = c("Ideal calibration"="dashed","Current KFRE"="solid"),
    breaks = c("Ideal calibration","Current KFRE")
  ) +
  guides(
    color = guide_legend(order = 1),
    linetype = guide_legend(order = 1)
  ) +
  theme_bw() +
  theme(
    text = element_text(size = 50, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 50, face = "bold"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 50),
    axis.text.y = element_text(size = 50),
    axis.text = element_text(size = 50),
    legend.title = element_text(size = 45, face = "bold"),
    legend.text = element_text(size = 40),
    legend.position = "blank"  # change to "none" if you really want to hide it
  )

  
ggsave(p3,filename = "Figure_5c_V2_Benchmark.jpeg",width = 45,height = 20, dpi=300)


figure_5_data2 = subset(figure_5_data,figure_5_data$Time2=="5 years (Restricted plot)" & figure_5_data$Model=="Current KFRE")

p4 = ggplot(figure_5_data2, aes(
  x = risk,
  y = obs,
  group = Model,
  color = Model,
  linetype = Model
))+
  geom_abline(
    data = ideal_line_df,
    aes(slope = slope, intercept = intercept,
        color = label, linetype = label),
    linewidth = 3,
    key_glyph = ggplot2::draw_key_path   # <- makes legend line horizontal
  ) +
  geom_line(linewidth = 3) +
  scale_y_continuous(breaks = seq(0, 0.1, 0.05), limits = c(0, 0.1)) +
  scale_x_continuous(breaks = seq(0, 0.1, 0.05), limits = c(0, 0.1)) +
  scale_color_manual(
    values = c("Ideal calibration"="red","Current KFRE"="#56B4E9"),
    breaks = c("Ideal calibration","Current KFRE")
  ) +
  scale_linetype_manual(
    values = c("Ideal calibration"="dashed","Current KFRE"="solid"),
    breaks = c("Ideal calibration","Current KFRE")
  ) +
  guides(
    color = guide_legend(order = 1),
    linetype = guide_legend(order = 1)
  ) +
  theme_bw() +
  theme(
    text = element_text(size = 50, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 50, face = "bold"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 50),
    axis.text.y = element_text(size = 50),
    axis.text = element_text(size = 50),
    legend.title = element_text(size = 45, face = "bold"),
    legend.text = element_text(size = 40),
    legend.justification = c(1, 1),
    legend.key.width = unit(6, "cm") # change to "none" if you really want to hide it
  )

ggsave(p4,filename = "Figure_5d_V2_Benchmark.jpeg",width = 45,height = 20, dpi=300)

library(patchwork)

version1 = (p3 + labs(title = "5 years (Full plot)"))+(p4 + labs(title = "5 years (Restricted plot)"))

ggsave(version1,filename = "Figure_5cd_V2_Benchmark.jpeg",width = 45,height = 20, dpi=300)


```

##### Combine Figure 5

```{r}

version1 = ((p1 + labs(title = "2 years (Full plot)") + xlab("") + ylab("Observed probabilities"))+(p2 + labs(title = "2 years (Restricted plot)")+ xlab("") + ylab("")))/ ((p3 + labs(title = "5 years (Full plot)")+ xlab("Predicted probabilities") + ylab("Observed probabilities"))+(p4 + labs(title = "5 years (Restricted plot)") + theme(legend.position = "blank") + ylab("") + xlab("Predicted probabilities")))

ggsave(version1,filename = "Figure_5_Final_V2_Benchmark.jpeg",width = 47,height = 42.8, dpi=300)


```



## 6. Combine calibration slopes and intercept for  all models

```{r}

benchmark_cal_stats = readRDS("Calibration_summary_stats_Benchmark.rds") %>% tidyr::spread("Time","Metric estimate (95% CI)")
kfre1_cal_stats = readRDS("Calibration_summary_stats_KFREUK1.rds") %>% tidyr::spread("Time","Metric estimate (95% CI)")
kfre2_cal_stats = readRDS("Calibration_summary_stats_KFREUK2.rds") %>% tidyr::spread("Time","Metric estimate (95% CI)")

cal_stats = rbind(benchmark_cal_stats,kfre1_cal_stats,kfre2_cal_stats)

write.csv(cal_stats,"Calibration_stats_all_models.csv",row.names = F)


```




