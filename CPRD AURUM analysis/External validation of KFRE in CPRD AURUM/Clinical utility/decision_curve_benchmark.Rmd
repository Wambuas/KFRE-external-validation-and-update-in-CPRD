---
title: "R Notebook"
output: html_notebook
---




```{r}
rm(list = ls())

library(tidyverse)
library(riskRegression)
library(plyr)
#library(tidysurv)
library(data.table)
library(stringr)
library(parallel)
library(tableone)
library(muhaz)
library(survival)
library(Hmisc)
library(MASS)
library(mfp)
library(reshape2)
library(flexsurv)
library(devtools)
library(prodlim)
library(rms)
library(rstpm2)
library(survcomp)
library(glmnet)
library(caret)
library(sjPlot)
library(knitr)
library(webshot)
library(pROC)
library(rmda)
library(pseudo)
library(lava)
library(pec)
library(mice)
library(miceadds)
library(dcurves)

```


# IMPUTED DATA

## 1. Benchmark model

```{r}

imputed_data_with_scores = readstata13::read.dta13("IMPUTED_data_with__Benchmark_scores.dta")

imputed_data_with_scores = imputed_data_with_scores %>% dplyr::select(
  patient_id,
  time1,status1,
  LP,
 score_2yrs_Benchmark,
 score_5yrs_Benchmark) %>% dplyr::rename(PRACTICE_PATIENT_ID=patient_id)



```


```{r}
imputed_data_with_scores$status_cause1 = ifelse(imputed_data_with_scores$status1==1,1,0)
```


### Decision curve

#### 2 years

```{r}
pdf("Decision_Curve_2_years_BenchmarkOnly.pdf")

dca(Surv(time1, status_cause1)~score_2yrs_Benchmark,
    data = imputed_data_with_scores,
    time = 2,
    thresholds = seq(0, 1, 0.01),
    label = list(score_2yrs_Benchmark="Benchmark"))%>% standardized_net_benefit() -> p1

print(p1)
dev.off()


```


```{r}

x=dca(Surv(time1, status_cause1)~score_2yrs_Benchmark,
    data = imputed_data_with_scores,
    time = 2,
    thresholds = seq(0, 1, 0.01),
    label = list(score_2yrs_Benchmark="Benchmark")) %>% standardized_net_benefit()


p2=as_tibble(x) %>%
  dplyr::filter(!is.na(standardized_net_benefit)) %>%
  ggplot(aes(x = threshold, y = standardized_net_benefit, color = label)) +
  stat_smooth(method = "loess", se = FALSE, formula = "y ~ x", 
    span = 0.33,size=5) +
  coord_cartesian(ylim = c(-0.06, 1)) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Threshold Probability", y = "Standardized Net Benefit", 
    color = "") +
  theme_bw()+theme(text = element_text(size=50,face="bold"),
        axis.title=element_text(size=50,face="bold"),
        axis.text.x = element_text(angle=90, hjust=1,vjust = 1,size = 50),
        axis.text.y = element_text(size = 50),
        axis.text=element_text(size=50))

ggsave(p2,filename = "Decision_Curve_2_years_BenchmarkOnlly.jpeg",width = 35,height = 30, dpi=300)


```


#### 5 years

```{r}

pdf("Decision_Curve_5_years_BenchmarkOnly.pdf")

dca(Surv(time1, status_cause1)~score_5yrs_Benchmark,
    data = imputed_data_with_scores,
    time = 5,
    thresholds = seq(0, 1, 0.01),
    label = list(score_5yrs_Benchmark="Benchmark"))%>% standardized_net_benefit() -> p1

print(p1)
dev.off()


```


```{r}

x=dca(Surv(time1, status_cause1)~score_5yrs_Benchmark,
    data = imputed_data_with_scores,
    time = 5,
    thresholds = seq(0, 1, 0.01),
    label = list(score_5yrs_Benchmark="Benchmark")) %>% standardized_net_benefit()


#x1=x[["dca"]]

p5=as_tibble(x) %>%
  dplyr::filter(!is.na(standardized_net_benefit)) %>%
  ggplot(aes(x = threshold, y = standardized_net_benefit, color = label)) +
  stat_smooth(method = "loess", se = FALSE, formula = "y ~ x", 
    span = 0.33,size=5) +
  coord_cartesian(ylim = c(-0.06, 1)) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Threshold Probability", y = "Standardized Net Benefit", 
    color = "") +
  theme_bw()+theme(text = element_text(size=50,face="bold"),
        axis.title=element_text(size=50,face="bold"),
        axis.text.x = element_text(angle=90, hjust=1,vjust = 1,size = 50),
        axis.text.y = element_text(size = 50),
        axis.text=element_text(size=50))

ggsave(p5,filename = "Decision_Curve_5_years_BenchmarkOnlly.jpeg",width = 35,height = 30, dpi=300)

```


