---
title: "R Notebook"
output: html_notebook
---


```{r}

rm(list = ls())

library(tidyverse)
library(riskRegression)
library(plyr)
#library(tidysurv)
library(data.table)
library(stringr)
library(parallel)
library(tableone)
library(muhaz)
library(survival)
library(Hmisc)
library(MASS)
library(mfp)
library(reshape2)
library(flexsurv)
library(devtools)
library(prodlim)
library(rms)
library(rstpm2)
library(survcomp)
library(glmnet)
library(caret)
library(sjPlot)
library(knitr)
library(webshot)
library(pROC)
library(rmda)
library(pseudo)
library(lava)
library(pec)
library(mice)
library(miceadds)
library(haven)
library(foreign)


pacman::p_load(
  survival,
  rms,
  mstate,
  pseudo,
  pec,
  riskRegression,
  plotrix,
  knitr,
  splines,
  kableExtra,
  gtsummary,
  boot,
  tidyverse,
  rsample,
  gridExtra,
  webshot,
  riskRegression
)

```


## Importing simulated data

```{r}

example_data = read.csv("example_simulated_data.csv")

names(example_data)

```

### Convert ACR from mg/mmol to mg/g - multiply by 8.84

```{r}
example_data$ACR_value = example_data$ACR_mg_mmol*8.84
```


### Recode variables and add fractional polynomials to match naming of models coefficients

```{r}

example_data = example_data %>% dplyr::mutate(
    # ACR polynomials
    acr1 = ACR_value/100,
    acr2 = log(ACR_value/100),
    #Age polynomials
    age1 = (age_years/100)^-1,
    age2 = (age_years/100)^3,
    #eGFR polynomials
    eGFR1 = log(eGFR_ml_min_1.73m2/100),
    eGFR2 = (eGFR_ml_min_1.73m2/100)^0.5,
    
    diabetic = diabetes_status,
    
    white_ethnicity = ifelse(ethnicity=="White",1,0),
    black_ethnicity = ifelse(ethnicity=="Black",1,0),
    asian_ethnicity = ifelse(ethnicity=="Asian",1,0),
    mixed_ethnicity = ifelse(ethnicity=="Mixed",1,0),
    other_ethnicity = ifelse(ethnicity=="Other",1,0),
    unknown_ethnicity = ifelse(ethnicity=="Unknown",1,0)
    
    )

```


## KFRE-UK

### Importing KFRE-UK model

```{r}

kfre_uk_model = readRDS("/rds/projects/s/subramaa-mum-predict/SteveW/KFRE/Final dataset/Updated data October/15 months ACR Imputed/October 2024/Updated models/2026/model_info_updated_kfre_only.rds")

```


### Calculating the risk score

#### Define function (from https://github.com/survival-lumc/ValidationCompRisks/blob/main/sharing_CSC_model.R)

```{r}

predictRisk_shared_CSC <- function(model_info, newdata, horizon, primary_event) {

  # ---- local helper (only RHS, no Surv re-evaluation)
  mm_rhs <- function(terms_obj, data) {
    tt <- stats::delete.response(terms_obj) # drop Surv(...) from terms
    mf <- stats::model.frame(tt, data = data, na.action = stats::na.pass)
    stats::model.matrix(tt, data = mf)
  }

  # ---- checks
  info_names <- c("coefficients", "baseline_hazards", "model_terms")
  if (any(!(names(model_info) %in% info_names))) {
    stop(paste0("Names of model_info components should be: ",
                paste(info_names, collapse = ", ")))
  }

  n_causes <- unique(vapply(model_info, length, FUN.VALUE = integer(1L)))
  if (length(n_causes) > 1) stop("Elements of model_info must all have length = number of causes.")
  if (!(primary_event %in% seq_len(n_causes))) stop("primary_event out of range.")
  if (!is.numeric(horizon) || length(horizon) != 1L || is.na(horizon) || horizon < 0) {
    stop("horizon must be a single non-missing number >= 0")
  }

  causes_ind <- seq_len(n_causes)

  # ---- linear predictors for all causes (aligned to nrow(newdata))
  linpreds <- lapply(causes_ind, function(cause) {
    mm <- mm_rhs(model_info$model_terms[[cause]], newdata)
    as.numeric(mm[, -1, drop = FALSE] %*% model_info$coefficients[[cause]])
  })

  # ---- baseline time grid for horizon indexing
  time_points <- model_info$baseline_hazards[[primary_event]][["time"]]
  if (is.null(time_points) || !length(time_points)) stop("No time grid found in baseline_hazards for primary_event.")
  idx_h <- max(which(time_points <= horizon), 0L)

  # ---- absolute risks
  preds <- vapply(seq_len(nrow(newdata)), function(id) {

    # if missing covariates for any cause -> return NA (change policy if you prefer)
    if (any(vapply(causes_ind, function(cause) is.na(linpreds[[cause]][id]), logical(1L)))) {
      return(NA_real_)
    }

    hazards <- vapply(causes_ind, function(cause) {
      bh <- model_info$baseline_hazards[[cause]][["hazard"]]
      if (length(bh) != length(time_points)) stop("Baseline hazard length mismatch across causes.")
      cumhaz <- bh * exp(linpreds[[cause]][id])
      diff(c(0, cumhaz))
    }, FUN.VALUE = numeric(length(time_points)))

    surv <- cumprod(1 - rowSums(hazards))
    cuminc <- cumsum(hazards[, primary_event] * c(1, surv[-length(surv)]))

    if (idx_h == 0L) 0 else cuminc[idx_h]

  }, FUN.VALUE = numeric(1L))

  preds
}

```

#### Calculate the scores for KFRE-UK at 2 and 5 years

##### 2 years

```{r}

horiz = 2
cause_interest = 1

example_data$score_2yrs_KFREUK <- predictRisk_shared_CSC(
  kfre_uk_model,
  newdata = example_data,
  horizon = horiz, 
  primary_event = cause_interest)

```

##### 5 years

```{r}

horiz = 5
cause_interest = 1


example_data$score_5yrs_KFREUK <- predictRisk_shared_CSC(
  kfre_uk_model,
  newdata = example_data,
  horizon = horiz, 
  primary_event = cause_interest)

```



### KFRE-UK-Plus

```{r}

kfre_uk_plus_model = readRDS("/rds/projects/s/subramaa-mum-predict/SteveW/KFRE/Final dataset/Updated data October/15 months ACR Imputed/October 2024/Updated models/2026/model_info_updated_kfre_plus.rds")

```

#### Calculate the scores for KFRE-UK-Plus at 2 and 5 years

##### 2 years

```{r}

horiz = 2
cause_interest = 1

example_data$score_2yrs_KFREUKPlus <- predictRisk_shared_CSC(
  kfre_uk_plus_model,
  newdata = example_data,
  horizon = horiz, 
  primary_event = cause_interest)

```

##### 5 years

```{r}

horiz = 5
cause_interest = 1

example_data$score_5yrs_KFREUKPlus <- predictRisk_shared_CSC(
  kfre_uk_plus_model,
  newdata = example_data,
  horizon = horiz, 
  primary_event = cause_interest)

```

### View the scores for first 6 rows of data

```{r}
head(example_data %>% dplyr::select(id,score_2yrs_KFREUK,score_5yrs_KFREUK,score_2yrs_KFREUKPlus,score_5yrs_KFREUKPlus))
```

